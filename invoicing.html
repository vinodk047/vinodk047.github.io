<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice Creator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#0ea5a4;--muted:#6b7280;--card:#ffffff}
    body{font-family:Inter,system-ui,Segoe UI,Arial; background:#f3f4f6; margin:0;padding:28px}
    .container{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:350px 1fr;gap:20px}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    h1{margin:0 0 8px;font-size:18px}
    h2{margin-top:16px;font-size:14px;margin-bottom:8px}
    label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
    input[type=text], input[type=email], input[type=number], textarea{width:100%;padding:6px 8px;border-radius:6px;border:1px solid #e6e6e6;margin-top:4px;font-size:12px}
    textarea{resize:vertical;min-height:60px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:4px;border-bottom:1px solid #eee;text-align:left;font-size:11px}
    .row-actions{display:flex;gap:6px;margin-top:8px}
    button{background:var(--accent);color:white;padding:6px 10px;border-radius:6px;border:0;cursor:pointer;font-size:12px}
    button.ghost{background:#eef2f2;color:#064e4e}
    .preview{overflow:auto;height:85vh}
    .invoice-box{width:100%;background:white;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);max-width:200mm;margin:0 auto;min-height:250mm}
    .pdf-table{width:100%;border-collapse:collapse;margin:15px 0;font-size:11px;table-layout:fixed}
    .pdf-table th{background:#2d5016;color:white;padding:6px 4px;text-align:left;border:1px solid #2d5016;font-weight:600;font-size:10px}
    .pdf-table td{padding:6px 4px;border:1px solid #ccc;vertical-align:top;word-wrap:break-word;font-size:10px}
    .company-logo{max-width:100px;max-height:60px;object-fit:contain;display:block}
    .invoice-header{page-break-inside:avoid}
    .invoice-totals{page-break-inside:avoid;margin-top:20px}
    .invoice-notes{page-break-inside:avoid;margin-top:20px}
    @media print {
      .invoice-box{box-shadow:none;padding:20px;max-width:none}
      .pdf-table{page-break-inside:avoid}
      .pdf-table thead{display:table-header-group}
    }
    .flex{display:flex;gap:8px;align-items:center}
    .text-muted{color:var(--muted);font-size:11px}
    .total{font-weight:700;font-size:14px}
    .save-load-section{margin-top:12px;padding:8px;background:#f8f9fa;border-radius:6px;border:1px solid #e6e6e6}
    .save-load-actions{display:flex;gap:6px;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Create Invoice</h1>
      <div>
        <label>From (Your company)</label>
        <input id="fromName" type="text" placeholder="Company name, address" value="EcoFibre Paper and Packaging" />
        <label>Bill To (Client)</label>
        <input id="toName" type="text" placeholder="Client name / company" />
        <label>Invoice #</label>
        <input id="invoiceNo" type="text" placeholder="e.g. INV-1001" />
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>Invoice Date</label>
            <input id="invoiceDate" type="date" placeholder="DD-MM-YYYY" />
          </div>
          <div style="width:160px">
            <label>Due Date</label>
            <input id="dueDate" type="date" placeholder="DD-MM-YYYY" />
          </div>
        </div>
        <label>Notes</label>
        <textarea id="notes" rows="2" placeholder="Payment terms, notes..."></textarea>
      </div>

      <h2 style="margin-top:18px;font-size:16px">Items</h2>
      <table id="itemsTable">
        <thead>
          <tr><th>Description</th><th style="width:150px">Qty</th><th style="width:50px">Unit Price</th><th style="width:50px">Amount</th><th style="width:40px"></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="row-actions">
          <button id="addItemBtn" class="ghost">+ Add item</button>
        </div>
        <div>
          <div class="flex"><div class="text-muted">Subtotal</div><div style="width:12px"></div><div id="subtotal" class="total">0.00</div></div>
          <div class="flex" style="margin-top:4px"><div class="text-muted">Tax (percent)</div><input id="taxPercent" type="number" value="0" style="width:60px;margin-left:6px;padding:4px;border-radius:4px;border:1px solid #e6e6e6;font-size:11px"/></div>
          <div class="flex" style="margin-top:4px"><div class="text-muted">Total</div><div style="width:12px"></div><div id="grandTotal" class="total">0.00</div></div>
        </div>
      </div>

      <!-- Save/Load Section removed -->

      <div style="display:flex;gap:6px;margin-top:12px">
        <button id="downloadPdfBtn">Download PDF</button>
        <button id="previewBtn" class="ghost">Update Preview</button>
      </div>
    </div>

    <div class="card preview">
      <div id="invoicePreview" class="invoice-box">
        <!-- rendered invoice preview -->
      </div>
    </div>
  </div>

  <!-- html2pdf from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    // ====== Helpers ======
    const $ = id => document.getElementById(id);
    const q = s => document.querySelector(s);

    const itemsTbody = document.querySelector('#itemsTable tbody');

    function money(x){return Number(x||0).toFixed(2)}

    function addItemRow(desc='', qty=1, price=0){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="desc" type="text" value="${desc}" placeholder="Item description" style="width:100%" /></td>
        <td><input class="qty" type="number" value="${qty}" min="0" style="width:100%" /></td>
        <td><input class="price" type="number" value="${price}" min="0" step="0.01" style="width:100%" /></td>
        <td class="amount">${money(qty*price)}</td>
        <td><button class="del">âœ•</button></td>
      `;
      itemsTbody.appendChild(tr);

      const qtyInput = tr.querySelector('.qty');
      const priceInput = tr.querySelector('.price');
      const descInput = tr.querySelector('.desc');
      const delBtn = tr.querySelector('.del');

      function recalc(){
        const qv = Number(qtyInput.value||0);
        const pv = Number(priceInput.value||0);
        tr.querySelector('.amount').textContent = money(qv*pv);
        renderTotals();
      }
      qtyInput.addEventListener('input', recalc);
      priceInput.addEventListener('input', recalc);
      descInput.addEventListener('input', () => {});
      delBtn.addEventListener('click', ()=>{ tr.remove(); renderTotals(); });

      renderTotals();
      return tr;
    }

    function getItems(){
      return Array.from(itemsTbody.querySelectorAll('tr')).map(tr=>({
        description: tr.querySelector('.desc').value,
        qty: Number(tr.querySelector('.qty').value||0),
        unitPrice: Number(tr.querySelector('.price').value||0),
        amount: Number(tr.querySelector('.amount').textContent||0)
      }));
    }

    function renderTotals(){
      const items = getItems();
      const subtotal = items.reduce((s,i)=>s + (i.qty*i.unitPrice),0);
      const taxPercent = Number($('taxPercent').value||0);
      const tax = subtotal * (taxPercent/100);
      const grand = subtotal + tax;
      $('subtotal').textContent = money(subtotal);
      $('grandTotal').textContent = money(grand);
    }

    function buildPreview(){
      const from = $('fromName').value;
      const to = $('toName').value;
      const invNo = $('invoiceNo').value;
      const invDate = $('invoiceDate').value;
      const dueDate = $('dueDate').value;
      const notes = $('notes').value;
      const items = getItems();

      let itemsHtml = items.map(it=>`<tr><td style="width:50%">${escapeHtml(it.description)}</td><td style="width:12%;text-align:center">${it.qty}</td><td style="width:18%;text-align:right">${money(it.unitPrice)}</td><td style="width:20%;text-align:right">${money(it.qty*it.unitPrice)}</td></tr>`).join('');
      const subtotal = $('subtotal').textContent;
      const taxPercent = $('taxPercent').value;
      const grand = $('grandTotal').textContent;

      // Embedded EcoFibre logo as SVG
      const logoSvg = `<img src="img/ecofibre_logo.png" alt="Ecofibre Logo" style="width: 100%; max-width: 160px; height: auto;">`;

      const html = `
        <div class="invoice-header" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #2d5016">
          <div style="display:flex;align-items:center;gap:12px">
            ${logoSvg}
            <div>
              <div style="font-weight:700;font-size:18px;color:#2d5016;margin-bottom:2px">${escapeHtml(from)}</div>
              <div style="color:#666;font-size:14px;font-weight:600;text-align:center">INVOICE</div>
            </div>
          </div>
          <div style="text-align:right;font-size:12px">
            <div style="margin-bottom:3px"><strong>Invoice #: </strong>${escapeHtml(invNo)}</div>
            <div style="margin-bottom:3px"><strong>Date: </strong>${escapeHtml(invDate)}</div>
            <div><strong>Due: </strong>${escapeHtml(dueDate)}</div>
          </div>
        </div>
        
        <div style="margin-bottom:20px">
          <div style="font-weight:600;margin-bottom:6px;color:#2d5016;font-size:13px">Bill To:</div>
          <div style="color:#666;line-height:1.4;font-size:12px">${escapeHtml(to).replace(/\n/g, '<br>')}</div>
        </div>
        
        <table class="pdf-table">
          <thead>
            <tr>
              <th style="width:50%;background:#2d5016;color:white">Description</th>
              <th style="width:12%;text-align:center;background:#2d5016;color:white">Qty</th>
              <th style="width:18%;text-align:right;background:#2d5016;color:white">Unit Price</th>
              <th style="width:20%;text-align:right;background:#2d5016;color:white">Amount</th>
            </tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        
        <div class="invoice-totals" style="margin-top:25px;display:flex;justify-content:flex-end">
          <div style="width:250px;border-top:2px solid #2d5016;padding-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px">
              <div style="color:#666">Subtotal:</div>
              <div style="font-weight:600">${subtotal}</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px">
              <div style="color:#666">Tax (${escapeHtml(taxPercent)}%):</div>
              <div style="font-weight:600">${money(Number(subtotal)*(Number(taxPercent)/100))}</div>
            </div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid #666;font-size:16px;font-weight:700;color:#2d5016;margin-top:8px">
              <div>Total:</div>
              <div>${grand}</div>
            </div>
          </div>
        </div>
        
        ${notes ? `<div class="invoice-notes" style="margin-top:25px;padding:12px;background:#f8f9fa;border-left:4px solid #2d5016;border-radius:4px;page-break-inside:avoid">
          <div style="font-weight:600;margin-bottom:6px;color:#2d5016;font-size:12px">Notes:</div>
          <div style="color:#666;line-height:1.4;font-size:11px">${escapeHtml(notes).replace(/\n/g, '<br>')}</div>
        </div>` : ''}
      `;

      document.getElementById('invoicePreview').innerHTML = html;
    }

    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>\"']/g, function(s){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s];});
    }

    // Collect invoice data for saving
    function collectInvoiceData(){
      renderTotals();
      const data = {
        from: $('fromName').value,
        to: $('toName').value,
        invoiceNo: $('invoiceNo').value,
        invoiceDate: $('invoiceDate').value,
        dueDate: $('dueDate').value,
        notes: $('notes').value,
        taxPercent: $('taxPercent').value,
        subtotal: $('subtotal').textContent,
        total: $('grandTotal').textContent,
        items: getItems(),
        timestamp: new Date().toISOString()
      };
      return data;
    }

    // Event listeners
    document.getElementById('addItemBtn').addEventListener('click', ()=> addItemRow());
    document.getElementById('previewBtn').addEventListener('click', ()=>{ renderTotals(); buildPreview(); });
    document.getElementById('downloadPdfBtn').addEventListener('click', async ()=>{
      renderTotals(); 
      buildPreview();
      
      // Wait a moment for SVG to render
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const element = document.getElementById('invoicePreview');
      
      const opt = { 
        margin: [0.3, 0.3, 0.3, 0.3], 
        filename: (document.getElementById('invoiceNo').value||'invoice') + '.pdf', 
        image: { 
          type: 'jpeg', 
          quality: 1.0 
        }, 
        html2canvas: { 
          scale: 3,
          useCORS: true,
          allowTaint: true,
          letterRendering: true,
          logging: false,
          width: element.offsetWidth,
          height: element.offsetHeight,
          scrollX: 0,
          scrollY: 0,
          backgroundColor: '#ffffff',
          removeContainer: false
        }, 
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true,
          precision: 16
        },
        pagebreak: { 
          mode: ['avoid-all', 'css', 'legacy'],
          before: '.page-break-before',
          after: '.page-break-after',
          avoid: ['tr', 'td', 'th']
        }
      };
      
      try {
        await html2pdf().set(opt).from(element).save();
      } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF. Please try again.');
      }
    });

    // Save invoice as JSON - removed
    // Load invoice from JSON - removed

    // Logo upload handling - removed

    // Update totals when tax percent changes
    document.getElementById('taxPercent').addEventListener('input', renderTotals);

    // initial state
    addItemRow('Website design',1,1500);
    addItemRow('Hosting (annual)',1,120);
    renderTotals(); buildPreview();
  </script>
</body>
</html>